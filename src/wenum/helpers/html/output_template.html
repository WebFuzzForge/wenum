<!DOCTYPE html>
<html>

  <head>
    <!-- TODO Include these files in the local file to ensure no internet connection is necessary for using the HTML report-->
    <!-- Additional icon fonts. Wunderbaum uses bootstrap icons by default. -->
    <link
      rel="stylesheet"
      href="file:////bootstrap-icons-1.11.3/font/bootstrap-icons.css"
    />
    <!-- Wunderbaum CSS and Library -->
    <link
      rel="stylesheet"
      href="file:////wunderbaum-0.7.0/dist/wunderbaum.css"
    />
    <script
      defer
      src="file:////wunderbaum-0.7.0/dist/wunderbaum.umd.min.js"
    ></script>
  </head>

  <body>

    <input type="file" id="wenum-file" name="wenum-file" accept=".json, text/plain, application/json", onChange="handleFile(this.files[0])" />

    <div id="wenum-tree" class="wb-skeleton wb-initializing wb-fade-expander"></div>

    <script>

        async function handleFile(file) {
            let wenum_output = await (new Response(file)).text();
            console.log(wenum_output);
            jsonfile = JSON.parse(wenum_output);

            console.log(jsonfile);
            let new_json = [];

            for (response of jsonfile.responses) {
                const url = new URL(response.url);
                const hostname = url.hostname;
                let port;
                if (url.port.length > 0) {
                    port = url.port;
                }
                else {
                    if (url.protocol === "https:") {
                        port = 443;
                    }
                    else if (url.protocol === "http:") {
                        port = 80;
                    }
                    // Undefined
                    else {
                        port = 0;
                    }
                }
                let host_index;
                let port_index;

                // Check if an entry with the hostname already exists
                for (var index = 0; index < new_json.length; index++) {
                    if (new_json[index].title === hostname) {
                        host_index = index;
                        break;
                    }
                }
                // If it doesnt exist, add such an entry to the array
                if (host_index === undefined) {
                    new_json.push({"title": hostname, "expanded": true});
                    host_index = new_json.length - 1;
                }
                if (new_json[host_index].children === undefined) {
                    new_json[host_index].children = [];
                }
                let port_array = new_json[host_index].children;

                // Check for port entry of hostname entry
                for (var index = 0; index < port_array.length; index++) {
                    if (port_array[index].title === port) {
                        port_index = index;
                        break;
                    }
                }
                if (port_index === undefined) {
                    new_json[host_index].children.push({"title": port, "expanded": true});
                    port_index = new_json[host_index].children.length - 1;
                }

                if (new_json[host_index].children[port_index].children === undefined) {
                    new_json[host_index].children[port_index].children = [];
                }


                // Remove this and continue hierarchy based on path instead
                //new_json[host_index].children[port_index].children.push(response);

                // '/' -> ['', '']; '/test/admin/index.html' -> ['', 'test', 'admin', 'index.html']
                split_path = url.pathname.split('/');
                // Replace empty fields with the base / instead
                for (index in split_path) {
                    if (split_path[index].length === 0) {
                        split_path[index] = '/';
                    }
                }

                let current_level = new_json[host_index].children[port_index].children;
                // The first index needs to be ignored in this loop due to how the iteration is handled
                for (var index = 1; index < split_path.length; index++) {
                    let child_index;
                    // For the last iteration append the actual response
                    if (index === (split_path.length - 1)) {
                        response.title = split_path[index];
                        current_level.push(response)
                        break;
                    }

                    // Check if that child already exists
                    for (var index = 0; index < current_level.length; index++) {
                        if (current_level[index].title === split_path[index]) {
                            child_index = index;
                            break;
                        }
                    }
                    if (child_index === undefined) {
                        current_level.push({"title": split_path[index], "expanded": true});
                        child_index = new_json[host_index].children.length - 1;
                    }

                    if (current_level[child_index].children === undefined) {
                        current_level[child_index].children = [];
                    }

                    current_level = current_level[child_index].children;

                }
            }

            const tree = new mar10.Wunderbaum({
                element: document.getElementById("wenum-tree"),
                source: {
                    children: new_json,
                        "_keyMap": {}},
                init: (e) => {
                    e.tree.setFocus();
                },
                render: function (e) {
                    const node = e.node;

                    for (const col of Object.values(e.renderColInfosById)) {
                        switch (col.id) {
                            default:
                                // Assumption: we named column.id === node.data.NAME
                                col.elem.textContent = node.data[col.id];
                                break;
                        }
                    }
                },
                columns: [
                    { id: "*", title: "Path", width: "350px" },
                    { id: "id", title: "ID", width: "60px", classes: "wb-helper-end" },
                    { id: "method", title: "Method", width: "70px", classes: "wb-helper-end" },
                    { id: "req_body", title: "Request body", width: "100px", classes: "wb-helper-end" },
                    { id: "code", title: "Code", width: "50px", classes: "wb-helper-end" },
                    { id: "lines", title: "Lines", width: "50px", classes: "wb-helper-end" },
                    { id: "words", title: "Words", width: "50px", classes: "wb-helper-end" },
                    { id: "bytes", title: "Bytes", width: "60px", classes: "wb-helper-end", },
                    { id: "url", title: "URL", width: "200px", classes: "wb-helper-end", },
                    { id: "location", title: "Location header", width: "200px", classes: "wb-helper-end", },
                    { id: "server", title: "Server header", width: "200px", classes: "wb-helper-end", },
                    { id: "misc", title: "Misc", width: "200px", classes: "wb-helper-end", },
                ],
                activate: (e) => {
                    console.log(`Thank you for activating ${e.node}.`);
                },
            });
        }
    </script>

  </body>

</html>